"use client";

import { useAccount, useWriteContract, useWaitForTransactionReceipt } from "wagmi";
import { parseEther } from "viem";
import { ARBISECURE_ABI, CONTRACT_ADDRESS } from "@/lib/abi";
import { ConnectButton } from "@rainbow-me/rainbowkit";
import { useEffect } from "react";
import { toast } from "sonner";
import { motion } from "framer-motion";
import LandingHeader from "@/components/landing/LandingHeader";

interface DealData {
    title: string;
    description: string;
    amount: string;
    freelancer: string;
    arbiter: string;
}

interface DealReviewUIProps {
    dealData: DealData;
}

export default function DealReviewUI({ dealData }: DealReviewUIProps) {
    const { address, isConnected } = useAccount();
    const { writeContract, data: hash, isPending: isWritePending, error: writeError } = useWriteContract();

    const { isLoading: isConfirming, isSuccess: isConfirmed } = useWaitForTransactionReceipt({
        hash,
    });

    useEffect(() => {
        if (isConfirmed) {
            toast.success("Deal Created & Funded Successfully!", {
                description: "Funds are now held in escrow.",
                duration: 5000,
            });
        }
        if (writeError) {
            toast.error("Transaction Failed", {
                description: writeError.message
            });
        }
    }, [isConfirmed, writeError]);

    const handleCreateAndFund = () => {
        if (!isConnected || !address) {
            toast.error("Please connect your wallet first");
            return;
        }

        try {
            const parsedAmount = parseEther(dealData.amount);

            // Let wagmi handle gas estimation automatically
            writeContract({
                address: CONTRACT_ADDRESS,
                abi: ARBISECURE_ABI,
                functionName: "create_deal",
                args: [dealData.freelancer as `0x${string}`, parsedAmount, dealData.arbiter as `0x${string}`],
                value: parsedAmount,
            });
        } catch (error) {
            console.error("Error preparing transaction:", error);
            toast.error("Failed to prepare transaction. Please try again.");
        }
    };

    return (
        <div className="min-h-screen w-full bg-[#0a0a0a] text-white relative overflow-hidden font-sans selection:bg-white/20">
            {/* Background Gradients */}
            <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-900 via-[#0a0a0a] to-[#0a0a0a] pointer-events-none"></div>
            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-white/5 rounded-full blur-[120px] pointer-events-none animate-pulse-slow"></div>

            <div className="relative z-10 flex flex-col min-h-screen">
                <LandingHeader />

                <div className="flex-grow pt-20 pb-20 px-4 md:px-0 max-w-2xl mx-auto w-full">
                    <motion.div
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        className="space-y-8"
                    >
                        <div className="text-center space-y-4">
                            <span className="inline-block px-3 py-1 rounded-full bg-white/10 border border-white/20 text-xs font-mono text-gray-300">
                                INCOMING AGREEMENT
                            </span>
                            <h1 className="text-4xl md:text-5xl font-header text-white">
                                Review & Fund
                            </h1>
                            <p className="text-gray-400 font-serif italic text-lg">
                                You have been invited to fund a secure escrow deal.
                            </p>
                        </div>

                        <div className="bg-glass border border-glass-border p-8 rounded-2xl space-y-6 shadow-2xl relative overflow-hidden group hover:border-white/20 transition-all duration-300">
                            <div className="absolute inset-0 bg-gradient-to-br from-white/5 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none"></div>

                            {/* Deal Details */}
                            <div className="space-y-6 relative z-10">
                                <div>
                                    <label className="text-xs font-mono text-gray-500 uppercase block mb-1">Agreement Title</label>
                                    <p className="text-2xl font-header text-white">{dealData.title}</p>
                                </div>

                                {dealData.description && (
                                    <div>
                                        <label className="text-xs font-mono text-gray-500 uppercase block mb-1">Description</label>
                                        <p className="text-gray-400 font-mono text-sm leading-relaxed whitespace-pre-wrap">{dealData.description}</p>
                                    </div>
                                )}

                                <div className="h-px bg-white/10 w-full"></div>

                                <div className="grid grid-cols-2 gap-8">
                                    <div>
                                        <label className="text-xs font-mono text-gray-500 uppercase block mb-1">Total Amount</label>
                                        <p className="text-3xl font-header text-white">{dealData.amount} <span className="text-lg text-gray-500">ETH</span></p>
                                    </div>
                                    <div>
                                        <label className="text-xs font-mono text-gray-500 uppercase block mb-1">Freelancer</label>
                                        <p className="text-sm font-mono text-gray-300 break-all bg-black/30 p-2 rounded border border-white/5 hover:border-white/20 transition-colors cursor-help" title={dealData.freelancer}>
                                            {dealData.freelancer.slice(0, 6)}...{dealData.freelancer.slice(-4)}
                                        </p>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-mono text-gray-500 uppercase block mb-1">Arbiter (Dispute Resolver)</label>
                                    <p className="text-sm font-mono text-gray-400 break-all bg-black/30 p-2 rounded border border-white/5">
                                        {dealData.arbiter}
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Actions */}
                        <div className="space-y-4">
                            {!isConnected ? (
                                <div className="flex flex-col items-center p-6 bg-white/5 rounded-2xl border border-white/10">
                                    <p className="text-gray-400 mb-4 font-mono text-sm">Connect wallet to fund this deal</p>
                                    <ConnectButton showBalance={false} />
                                </div>
                            ) : (
                                <button
                                    onClick={handleCreateAndFund}
                                    disabled={isWritePending || isConfirming}
                                    className="w-full bg-white text-black py-4 rounded-full font-bold font-nav text-lg hover:bg-gray-200 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_0_30px_rgba(255,255,255,0.2)] hover:shadow-[0_0_50px_rgba(255,255,255,0.4)] relative overflow-hidden group"
                                >
                                    {isWritePending ? "Confirming in Wallet..." : isConfirming ? "Processing Transaction..." : "Create & Fund Deal"}

                                    {/* Shine Effect */}
                                    <div className="absolute inset-0 bg-white/40 skew-x-12 -translate-x-full group-hover:animate-shine"></div>
                                </button>
                            )}

                            <div className="text-center">
                                <p className="text-xs text-gray-600 font-mono">
                                    Powered by Arbitrum Stylus â€¢ Trustless & Secure
                                </p>
                            </div>
                        </div>
                    </motion.div>
                </div>
            </div>
        </div>
    );
}
